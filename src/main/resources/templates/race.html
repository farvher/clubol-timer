<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="head :: header">
<title>Getting Started: Serving Web Content</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>

	<div th:replace="header :: cabezote"></div>

	<div class="container">
		<div class="row">
			<!-- 			PANEL DE CRONOMETROS -->
			<div th:if="${race}!=null" class="panel panel-default ">
				<div class="panel-heading">
					<input type="hidden" th:value="${race.raceName}" id="raceName" />
					<label th:text="${race.raceName}" class="">Carrera</label> <label
						th:text="${race.description}">descripcion</label> <label
						id="dateRace" th:utext="${race.dateRace}">dateRace</label> <a
						th:href="@{/raceRunner/}+${race.raceName}"
						class="btn btn-default "
						title="Calculo de los tiempos marcados por los corredores">Tiempos
						Procesados</a> <a th:href="@{/race/}+${race.raceName}"
						class="btn btn-default active"
						title="Registro de todos los tiempos marcados sin calcular">Tags
						leidos</a>
				</div>
				<div class="panel-body ">
					<div class="row">
						<div class="col-md-2">
							<label>Cronometros</label>
						</div>
						<div class="col-md-1">
							<label>Inicio</label>
						</div>
						<div class="col-md-1">
							<label>Transcurrido</label>
						</div>
					</div>
					<div th:each="cr : ${race.chronometers}" class="row">
						<div class="col-md-2" th:text="${cr.chronometerName}"></div>
						<div class="col-md-1">
							<button type="button" onclick="setTimeStart(this)"
								th:text="${cr.timeStart}" th:value="${cr.id}"
								class=" btn btn-xs btn-default timestart"></button>
						</div>
						<div class="col-md-1 timepass">0:00:00</div>
					</div>



				</div>
				<div class="panel-footer">
					<form class="form-inline">
						<div class="form-group">
							<input type="text" placeholder="No Tag" id="noTagRace"
								class="form-control" /> <input type="time" step="2" placeholder="Hora"
								id="timeHour" class="form-control" />
						</div>
						<a class="btn btn-info" onclick="updateTable()"
							title="actualiza los registros de tag segun el no de chip ingresado">Actualizar</a>
						<a class="btn btn-info" onclick="saveTag()"
							title="guarda un registro tag segun la hora indicada y el no del chip">Guardar</a>
					<a onclick="tableToExcel('tableTimesRunners','tag detectados','tag_detectados.xls')" class="btn btn-info">Excel</a> 
					</form>

				</div>
			</div>

		</div>
		<table class="table table-bordered table-condensed table-striped" id="tableTimesRunners">
			<tr>
				<th>Chip No</th>
				<th>Nombre</th>
				<th>Apellido</th>
				<th>Chip Time</th>
				<th>Time</th>
				<th>Genero</th>
				<th>Distancia (Cronometro)</th>
				<th>Categoria</th>
				<th>Borrar</th>

			</tr>
			<tbody id="tableRace">
				<tr th:each=" t : ${tags}"
					th:class="${t.active}? 'success':'warning'">

					<td th:text="${t.position}"></td>
					<td th:text="${t.firstName}"></td>
					<td th:text="${t.lastName}"></td>
					<td th:text="${t.time}"></td>
					<td th:text="${t.passTime}"></td>
					<td th:text="${t.gender}"></td>
					<td th:text="${t.distance}"></td>
					<td th:text="${t.category}"></td>
					<td><a class="btn btn-xs btn-danger"
						href="#" th:onclick="'deleteTag(\'' + ${t.id} + '\');'">Borrar</a></td>
				</tr>
			</tbody>

		</table>


	</div>

	<script>

	function setTimeStart(btn){
		
		var today = new Date();
		  var h = today.getHours();
		  var m = today.getMinutes();
		  var s = today.getSeconds();
		  // add a zero in front of numbers<10
		  m = checkTime(m);
		  s = checkTime(s);
		  var timeStart = h+":"+m+":"+s;
		  $(btn).html(timeStart);
		  var idCrono = $(btn).val();
		  saveCronometerTimeStart(idCrono,timeStart,"0");
		}

	function setTimeEnd(btn){
		
		var today = new Date();
		  var h = today.getHours();
		  var m = today.getMinutes();
		  var s = today.getSeconds();
		  // add a zero in front of numbers<10
		  m = checkTime(m);
		  s = checkTime(s);
		  var timeEnd = h+":"+m+":"+s;
		  $(btn).html(timeEnd);
		  var idCrono = $(btn).val();
		  saveCronometerTimeStart(idCrono,"0",timeEnd);
		}

function updateTable(){
	var raceName = $("#raceName").val()
	var url ="/race/"+raceName+"/ajax"
	var noTag = $("#noTagRace").val();
	url = noTag==""?url:url+"/"+noTag;
	$.ajax({
		url : url,
		dataType : "json",
		success:function(data){
			$("#tableRace").html("");
			$.each(data,function(i,o){
				var register = "<tr class='"+(o.active?"success":"warning")+"'>";
				register+="<td>"+o.position+"</td>";
				register+="<td>"+o.firstName+"</td>";
				register+="<td>"+o.lastName+"</td>";
				register+="<td>"+o.time+"</td>";
				register+="<td>"+o.passTime+"</td>";
				register+="<td>"+o.gender+"</td>";
				register+="<td>"+o.distance+"</td>";
				register+="<td>"+o.category+"</td>";
				register+="<td>"+"<a class='btn btn-xs btn-danger' onclick='deleteTag("+o.id+")'>Borrar</a>"+"</td>";
				register+="</tr>";
				$("#tableRace").append(register);
				})
			
       data;
			},
		error:function(){
             	console.log("menu no cargado");
             }
		})
}


$(document).ready(function(){
	updateTranscurrido();
	setInterval(updateTranscurrido,1000);
// 	setInterval(updateTable, 1000);	
})

function checkTime(i) {
	  if (i < 10) {
	    i = "0" + i;
	  }
	  return i;
	}

function saveCronometerTimeStart(id,timeStart,timeEnd){

	var url = "/chronometer/";
	url+=id+"/";
	url+=timeStart+"/";
	url+=timeEnd+"";
	var params="";
	var func = function(data){
		console.log(data);
		};
	sendAjax(url,params,func,"GET");
	
}

function sendAjax(url,params,func,method){

	$.ajax({
		url : url,
		data:params,
		method:method,
		data:JSON.stringify(params),
		contentType:'application/json',
		success:func,
		error : function(er,ex,error){
			alert("error ajax: "+er);
			}
		})
}

function updateTranscurrido(){
	var lapse = [];
	$(".timestart").each(function(){
		var time = ($(this).html());
		var hour = time.split(":")[0];
		var minute = time.split(":")[1];
		var second = time.split(":")[2];
		var current = new Date();
		current.setHours(hour);
		current.setMinutes(minute);
		current.setSeconds(second)
		
		var currentLocal = new Date();
		var secondPass = (currentLocal.getTime() - current.getTime())/1000;
		lapse.push(time!='0:00:00'?convertSecondsToHHMMSS(secondPass):'00:00:00');
	})
	
	$(".timepass").each(function(i,o){
		$(this).html(lapse[i]);
		
	})
	
}
function saveTag(){
var notag = $("#noTagRace").val();
var hour = $("#timeHour").val();
var dateRace =$("#dateRace").html();
var functSave = function (data,status){ updateTable()};
if(dateRace!='' && hour !='' && notag!=''){
	hour = hour.substring(0,1)=='0' ? hour.substring(1,hour.length):hour
sendAjax("/save/"+notag+"/"+hour+"/"+dateRace,null,functSave,'get');

}else {
	alert('Complete el tiempo y/o numero de chip')
}
}

function deleteTag(id){
	if(confirm('desea eliminar el tiempo?')){
	sendAjax('/tag/delete/'+id,null,function(){updateTable()},'get');
	}
}


function convertSecondsToHHMMSS(seconds){
	var date = new Date(null);
	date.setSeconds(seconds); // specify value for SECONDS here
	return date.toISOString().substr(11, 8);
	}



</script>
</body>
</html>